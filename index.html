<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Matcher Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family:sans-serif; background:#0a0e27; color:#e0e6ed; margin:0; padding:0;}
header{padding:20px;text-align:center;background:#1a1f3a;}
h1{margin:0;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.container{padding:20px;}
.upload-section{display:flex;gap:20px;margin-bottom:20px;}
.upload-box{flex:1;padding:20px;border:2px dashed #4a5568;border-radius:12px;text-align:center;cursor:pointer;transition:.3s;}
.upload-box:hover{border-color:#667eea;}
.upload-box.has-file{border-color:#48bb78;border-style:solid;background:#1a2f23;}
.file-name{color:#48bb78;margin-top:5px;}
.stats-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;}
.stat-item{text-align:center;background:#1a1f3a;padding:10px;border-radius:8px;}
.stat-value.green{color:#48bb78;}
.stat-value.yellow{color:#ecc94b;}
.stat-value.red{color:#f56565;}
.stat-value.blue{color:#4299e1;}
.controls{display:flex;justify-content:space-between;margin-bottom:20px;}
select, button{padding:5px 10px;border-radius:6px;background:#2d3748;color:#e0e6ed;border:1px solid #4a5568;cursor:pointer;}
button.primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;}
button.success{background:#48bb78;color:#fff;border:none;}
.matching-area{display:grid;grid-template-columns:1fr 80px 1fr;gap:20px;height:400px;margin-bottom:20px;}
.table-panel{background:#1a1f3a;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;border:1px solid #2d3748;}
.panel-header{padding:10px;background:#0f1729;border-bottom:1px solid #2d3748;font-weight:600;}
.table-rows{overflow-y:auto;flex:1;padding:5px;}
.row-item{padding:8px;margin-bottom:5px;background:#0f1729;border-radius:6px;border:2px solid transparent;cursor:pointer;position:relative;transition:.2s;}
.row-item.selected{border-color:#667eea;}
.row-item.matched{border-color:#48bb78;background:#1a2f23;}
.row-item.suggested{border-color:#ecc94b;background:#2f2a1a;}
.row-content{display:flex;flex-direction:column;}
.connection-area{position:relative;background:#0f1729;border-radius:12px;border:1px solid #2d3748;}
svg{width:100%;height:100%;}
.connection-line{stroke-width:2;fill:none;transition:.3s;}
.connection-line.confirmed{stroke:#48bb78;stroke-width:3;}
.connection-line.suggested{stroke:#ecc94b;stroke-dasharray:5,5;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,14,39,.9);align-items:center;justify-content:center;z-index:1000;}
.modal.active{display:flex;}
.modal-content{background:#1a1f3a;border-radius:12px;padding:20px;width:90%;max-width:500px;border:1px solid #2d3748;}
.modal-header{font-size:1.2em;margin-bottom:10px;border-bottom:1px solid #2d3748;padding-bottom:5px;}
.drawer{position:fixed;right:0;top:0;width:300px;height:100%;background:#1a1f3a;border-left:2px solid #2d3748;padding:10px;overflow-y:auto;transition:.3s;transform:translateX(100%);}
.drawer.open{transform:translateX(0);}
.draggable-col{padding:5px 10px;margin-bottom:5px;border:1px solid #2d3748;border-radius:5px;background:#0f1729;cursor:grab;display:flex;align-items:center;gap:5px;}
</style>
</head>
<body>
<header>
<h1>‚ö° Data Matcher Pro</h1>
<p style="color:#a0aec0;">Raccordement intelligent de donn√©es</p>
</header>
<div class="container">

<div class="upload-section">
<div class="upload-box" id="upload1" onclick="document.getElementById('file1').click()">
<p>Table 1 (R√©f√©rence)</p>
<div class="file-name" id="filename1"></div>
<input type="file" id="file1" accept=".csv,.xlsx,.xls" style="display:none;">
</div>
<div class="upload-box" id="upload2" onclick="document.getElementById('file2').click()">
<p>Table 2 (√Ä matcher)</p>
<div class="file-name" id="filename2"></div>
<input type="file" id="file2" accept=".csv,.xlsx,.xls" style="display:none;">
</div>
</div>

<div class="stats-bar" id="statsBar" style="display:none;">
<div class="stat-item"><div class="stat-value green" id="matchedCount">0</div><div>‚úÖ Match√©s</div></div>
<div class="stat-item"><div class="stat-value yellow" id="suggestedCount">0</div><div>‚ö† Suggestions</div></div>
<div class="stat-item"><div class="stat-value red" id="orphan1Count">0</div><div>‚ùå Orphelins T1</div></div>
<div class="stat-item"><div class="stat-value blue" id="orphan2Count">0</div><div>‚ùå Orphelins T2</div></div>
</div>

<div class="controls" id="controls" style="display:none;">
<div>
<select id="filterSelect">
<option value="all">Tous</option>
<option value="matched">Match√©s</option>
<option value="suggested">Suggestions</option>
<option value="unmatched">Non-match√©s</option>
</select>
<button onclick="applyFilter()">‚úÖ Valider</button>
<button onclick="autoSuggest()">üîÑ Re-scanner</button>
</div>
<div>
<button class="success" onclick="exportMerged()" id="exportBtn" disabled>üì• Export CSV/XLSX</button>
<button onclick="toggleDrawer()">üìù Construire Trame</button>
</div>
</div>

<div class="matching-area" id="matchingArea" style="display:none;">
<div class="table-panel">
<div class="panel-header">Table 1</div>
<div class="table-rows" id="table1Rows"></div>
</div>
<div class="connection-area"><svg id="connectionSvg"></svg></div>
<div class="table-panel">
<div class="panel-header">Table 2</div>
<div class="table-rows" id="table2Rows"></div>
</div>
</div>
</div>

<div class="drawer" id="drawer">
<h3>Configurer la trame finale</h3>
<div id="columnList"></div>
<button class="primary" onclick="closeDrawer()">Fermer</button>
</div>

<div class="modal" id="matchModal">
<div class="modal-content">
<div class="modal-header">Confirmer le match</div>
<div class="modal-body">
<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:10px;">
<div id="modalRow1" style="background:#0f1729;padding:5px;border-radius:5px;"></div>
<div style="text-align:center;font-weight:bold;font-size:20px;">‚Üî</div>
<div id="modalRow2" style="background:#0f1729;padding:5px;border-radius:5px;"></div>
</div>
</div>
<div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
<button onclick="closeModal()">‚ùå Annuler</button>
<button class="primary" onclick="confirmMatch()">‚úì Valider</button>
</div>
</div>
</div>

<script>
// ---------- STATE ----------
const state={table1:[],table2:[],matches:[],selectedRow1:null,selectedRow2:null,pendingMatch:null};

// ---------- UPLOAD ----------
document.getElementById('file1').addEventListener('change',e=>handleFileUpload(e,1));
document.getElementById('file2').addEventListener('change',e=>handleFileUpload(e,2));
function handleFileUpload(e,num){
 const file=e.target.files[0]; if(!file) return;
 const reader=new FileReader();
 reader.onload=function(ev){
  const data=new Uint8Array(ev.target.result);
  const wb=XLSX.read(data,{type:'array'});
  const js=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  if(num===1){state.table1=js.map((r,i)=>({id:`t1_${i}`,...r})); document.getElementById('filename1').textContent='‚úì '+file.name;}
  else{state.table2=js.map((r,i)=>({id:`t2_${i}`,...r})); document.getElementById('filename2').textContent='‚úì '+file.name;}
  if(state.table1.length&&state.table2.length) initializeMatching();
 };
 reader.readAsArrayBuffer(file);
}

// ---------- INITIALIZE ----------
function initializeMatching(){
 document.getElementById('statsBar').style.display='grid';
 document.getElementById('controls').style.display='flex';
 document.getElementById('matchingArea').style.display='grid';
 renderTables();
 updateStats();
 renderColumnList();
}

// ---------- RENDER TABLES ----------
function renderTables(){renderTable(1); renderTable(2);}
function renderTable(num){
 const container=document.getElementById(`table${num}Rows`); container.innerHTML='';
 const table=num===1?state.table1:state.table2;
 table.forEach(r=>{
  const m=state.matches.find(x=>x.id1===r.id||x.id2===r.id);
  const div=document.createElement('div'); div.className='row-item'; div.dataset.rowId=r.id; div.dataset.table=num;
  if(m) div.classList.add(m.confirmed?'matched':'suggested');
  div.innerHTML=`<div class="row-content"><strong>${Object.keys(r).filter(k=>k!=='id')[0]}:</strong> ${r[Object.keys(r)[0]]}</div>`;
  div.addEventListener('click',()=>handleRowClick(r.id,num));
  container.appendChild(div);
 });
 drawConnections();
}

// ---------- ROW CLICK & MODAL ----------
function handleRowClick(id,num){
 if(num===1){state.selectedRow1=id; document.querySelectorAll('[data-table="1"]').forEach(el=>el.classList.remove('selected'));
 document.querySelector(`[data-row-id="${id}"]`)?.classList.add('selected');}
 else{state.selectedRow2=id; document.querySelectorAll('[data-table="2"]').forEach(el=>el.classList.remove('selected'));
 document.querySelector(`[data-row-id="${id}"]`)?.classList.add('selected');}
 if(state.selectedRow1&&state.selectedRow2) showMatchModal(state.selectedRow1,state.selectedRow2);
}
function showMatchModal(id1,id2){
 const r1=state.table1.find(r=>r.id===id1);
 const r2=state.table2.find(r=>r.id===id2);
 document.getElementById('modalRow1').innerHTML=Object.entries(r1).map(([k,v])=>`<div><strong>${k}:</strong> ${v}</div>`).join('');
 document.getElementById('modalRow2').innerHTML=Object.entries(r2).map(([k,v])=>`<div><strong>${k}:</strong> ${v}</div>`).join('');
 state.pendingMatch={id1,id2};
 document.getElementById('matchModal').classList.add('active');
}
function closeModal(){document.getElementById('matchModal').classList.remove('active'); state.pendingMatch=null; state.selectedRow1=null; state.selectedRow2=null; document.querySelectorAll('.row-item').forEach(el=>el.classList.remove('selected'));}
function confirmMatch(){
 if(!state.pendingMatch) return;
 const idx=state.matches.findIndex(m=>m.id1===state.pendingMatch.id1||m.id2===state.pendingMatch.id2);
 if(idx>=0) state.matches[idx]={...state.pendingMatch,confirmed:true,score:1};
 else state.matches.push({...state.pendingMatch,confirmed:true,score:1});
 closeModal(); renderTables(); updateStats();
}

// ---------- AUTO MATCH ----------
function autoSuggest(){
 state.table1.forEach(r1=>{
  if(state.matches.find(m=>m.id1===r1.id)) return;
  const val1=String(r1[Object.keys(r1).filter(k=>k!=='id')[0]]||'').toLowerCase();
  let best=null,bestScore=0;
  state.table2.forEach(r2=>{
   if(state.matches.find(m=>m.id2===r2.id)) return;
   const val2=String(r2[Object.keys(r2).filter(k=>k!=='id')[0]]||'').toLowerCase();
   const score=similarity(val1,val2);
   if(score>bestScore&&score>0.6){bestScore=score; best=r2.id;}
  });
  if(best) state.matches.push({id1:r1.id,id2:best,confirmed:false,score:bestScore});
 });
 renderTables(); drawConnections(); updateStats();
}
function similarity(a,b){const l=a.length>b.length?a:b;const s=a.length>b.length?b:a;return l.length===0?1:(l.length-editDistance(l,s))/l.length;}
function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();const costs=[];for(let i=0;i<=a.length;i++){let last=i;for(let j=0;j<=b.length;j++){if(i===0){costs[j]=j;}else if(j>0){let nv=costs[j-1];if(a.charAt(i-1)!==b.charAt(j-1)) nv=Math.min(Math.min(nv,last),costs[j])+1;costs[j-1]=last; last=nv;}}if(i>0) costs[b.length]=last;} return costs[b.length];}

// ---------- CONNECTIONS ----------
function drawConnections(){
 const svg=document.getElementById('connectionSvg'); svg.innerHTML='';
 state.matches.forEach(m=>{
  const r1El=document.querySelector(`[data-row-id="${m.id1}"]`);
  const r2El=document.querySelector(`[data-row-id="${m.id2}"]`);
  if(!r1El||!r2El) return;
  const rect1=r1El.getBoundingClientRect();
  const rect2=r2El.getBoundingClientRect();
  const svgRect=svg.getBoundingClientRect();
  const y1=rect1.top-svgRect.top+rect1.height/2;
  const y2=rect2.top-svgRect.top+rect2.height/2;
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1','0'); line.setAttribute('y1',y1);
  line.setAttribute('x2','80'); line.setAttribute('y2',y2);
  line.classList.add('connection-line',m.confirmed?'confirmed':'suggested');
  line.addEventListener('click',()=>{if(confirm('Supprimer ce match?')){state.matches=state.matches.filter(x=>x!==m);renderTables();drawConnections();updateStats();}});
  svg.appendChild(line);
 });
}
document.querySelectorAll('.table-rows').forEach(el=>el.addEventListener('scroll',drawConnections));
window.addEventListener('resize',drawConnections);

// ---------- STATS ----------
function updateStats(){
 const confirmed=state.matches.filter(m=>m.confirmed).length;
 const suggested=state.matches.filter(m=>!m.confirmed).length;
 const orphan1=state.table1.length-state.matches.length;
 const orphan2=state.table2.length-state.matches.length;
 document.getElementById('matchedCount').textContent=confirmed;
 document.getElementById('suggestedCount').textContent=suggested;
 document.getElementById('orphan1Count').textContent=orphan1;
 document.getElementById('orphan2Count').textContent=orphan2;
 document.getElementById('exportBtn').disabled=confirmed===0;
}

// ---------- FILTER ----------
function applyFilter(){
 const val=document.getElementById('filterSelect').value;
 document.querySelectorAll('.row-item').forEach(el=>{
  const r1=state.table1.find(r=>r.id===el.dataset.rowId);
  const r2=state.table2.find(r=>r.id===el.dataset.rowId);
  el.style.display='flex';
  const m=state.matches.find(x=>x.id1===el.dataset.rowId||x.id2===el.dataset.rowId);
  if(val==='matched'&&(!m||!m.confirmed)) el.style.display='none';
  else if(val==='suggested'&&(!m||m.confirmed)) el.style.display='none';
  else if(val==='unmatched'&&m) el.style.display='none';
}

// ---------- DRAWER ----------
function renderColumnList(){
 const container=document.getElementById('columnList'); container.innerHTML='';
 const allCols=[...new Set([...Object.keys(state.table1[0]||{}),...Object.keys(state.table2[0]||{})])];
 allCols.forEach(c=>{
  const div=document.createElement('div'); div.className='draggable-col'; div.draggable=true;
  div.innerHTML=`<input type="checkbox" checked> ${c}`;
  div.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',c); div.style.opacity='0.5';});
  div.addEventListener('dragend',e=>{div.style.opacity='1';});
  div.addEventListener('dragover',e=>{e.preventDefault(); div.style.borderColor='#667eea';});
  div.addEventListener('dragleave',e=>{div.style.borderColor='#2d3748';});
  div.addEventListener('drop',e=>{
   e.preventDefault(); div.style.borderColor='#2d3748';
   const dragged=e.dataTransfer.getData('text/plain');
   const children=[...container.children];
   const from=children.findIndex(x=>x.textContent.includes(dragged));
   const to=children.indexOf(div);
   if(from<to) container.insertBefore(children[from],children[to+1]);
   else container.insertBefore(children[from],children[to]);
  });
  container.appendChild(div);
 });
}
function toggleDrawer(){document.getElementById('drawer').classList.toggle('open');}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');}

// ---------- EXPORT ----------
function exportMerged(){
 const container=document.getElementById('columnList');
 const cols=[...container.children].filter(x=>x.querySelector('input').checked).map(x=>x.textContent.trim());
 const merged=[];
 state.table1.forEach(r1=>{
  const m=state.matches.find(x=>x.id1===r1.id&&x.confirmed);
  const r2=m?state.table2.find(x=>x.id2===m.id2):{};
  merged.push({...r1,...r2});
 });
 const finalData=merged.map(r=>cols.reduce((acc,c)=>{acc[c]=r[c]||'';return acc;},{}));
 // CSV
 const csv=Papa.unparse(finalData);
 const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
 const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='merged.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
 // XLSX
 const wb=XLSX.utils.book_new();
 const ws=XLSX.utils.json_to_sheet(finalData);
 XLSX.utils.book_append_sheet(wb,ws,'Merged');
 XLSX.writeFile(wb,'merged.xlsx');
}

// ---------- END ----------
</script>
</body>
</html>
